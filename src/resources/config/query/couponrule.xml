<?xml version="1.0" encoding="UTF-8" ?>
<mapper namespace="couponrule">
	<sql id="all">
	<![CDATA[
		select *
		  from (select auditId,
		               ixData,
		               ixData2,
		               modData,
		               auditType,
		               auditState,
		               resultDesc,
		               ruleid,
		               auditUser,
		               modtime,
		               goodssum,
		               value(state, 0) as state,
		               merid,
		               goodsid,
		               couponid,
		               generatemethod,
		               couponcodetype,
		               saledsum,
		               sellstartdate,
		               sellenddate,
		               usestartdate,
		               useenddate,
		               efftype,
		               effdays,
		               price,
		               submituser,
		               to_char(inTime, 'yyyy-mm-dd hh24:mi:ss') as inTime,
		               effwarndays,
		               switchAmt,
		               alarmCount,
		               alarmemail,
		               alarmmobile,
		               isAlarm,
		               ruletype,
                       originalprice,
                       export
		          from (select id         as auditId,
		                       ixData,
		                       ixData2,
		                       modData,
		                       auditType,
		                       state      as auditState,
		                       resultDesc
		                  from umpay.T_HFAUDIT
		                 where id in (select max(id) as auditId
		                                from umpay.T_HFAUDIT
		                               where tableName = 'UMPAY.T_COUPON_RULE'
		                               group by ixData)) a
		          full join (select ruleid,
		                           auditUser,
		                           modtime,
		                           goodssum,
		                           state,
		                           merid,
		                           goodsid,
		                           couponid,
		                           generatemethod,
		                           couponcodetype,
		                           saledsum,
		                           sellstartdate,
		                           sellenddate,
		                           usestartdate,
		                           useenddate,
		                           efftype,
		                           effdays,
		                           price,
		                           submituser,
		                           intime,
		                           effwarndays,
		                           switchAmt,
		                           alarmCount,
		                           alarmemail,
		                           alarmmobile,
		                           case
		                             when goodsSum = -1 or (goodsSum - switchAmt) > 0 then
		                              0
		                             else
		                              1
		                           end as isAlarm,
		                           ruletype,
		                           originalprice,
		                           export
		                      from umpay.T_COUPON_RULE) b
		            on a.ixData = b.ruleId) c
		 where 1 = 1
			#if( $ruleId && $ruleId!='' ) 
			   and ixData = :ruleId 
			#end
			#if( $isAlarm && $isAlarm!='' )
			   and isAlarm = :isAlarm 
			#end
			#if( $state && $state!='' ) 
			   and state = :state 
			#end
			#if( $auditState && $auditState!='' ) 
			   and auditState = :auditState 
			#end
			#if( $couponId && $couponId!='' ) 
			   and modData like '%"couponId":"$couponId"%' 
			#end
			#if( $merId && $merId!='' ) 
			   and modData like '%"merId":"$merId"%' 
			#end
			#if( $goodsId && $goodsId!='' ) 
			   and modData like '%"goodsId":"$goodsId"%' 
			#end
		 order by ixData desc
	]]>
	</sql>

	<sql id="couponrulelog">
	<![CDATA[
		select a.couponId,a.merId,a.goodsId,
		               a.operdata,
		               a.opertype,
		               a.moduser,
		               a.intime
		          from (select ixdata1         as couponId,
		          			   ixdata2  as merId,
		          			   ixdata4  as goodsId,
		                       operdata,
		                       opertype,
		                       moduser,
		                       to_char(intime,'yyyy-MM-dd hh24:mi:ss') intime
                      from umpay.T_COUPON_OPLOG
                      where businessobject='umpay.T_COUPON_RULE'
                     ) a
     where 1 = 1
       #if( $couponId && $couponId!='' ) 
           and couponId = :couponId
       #end
       #if( $merId && $merId!='' ) 
           and merId = :merId
       #end
       #if( $goodsId && $goodsId!='' ) 
           and goodsId = :goodsId
       #end
       #if( $moduser && $moduser!='' ) 
           and moduser = :moduser
       #end
       #if( $logopttype && $logopttype!='' ) 
           and opertype = :logopttype
       #end
     order by intime desc
	]]>
	</sql>
</mapper> 