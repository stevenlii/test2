<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="stylesheet" href="${request.contextPath}/js/ui/themes/default/om-all.css" type="text/css">
<link rel="stylesheet" type="text/css" href="${request.contextPath}/profile/default/css/common.css" >
<script src="$request.contextPath/js/ui/jquery.min.js"></script>
<script src="$request.contextPath/js/ui/js/om-core.js"></script>
<script type="text/javascript" src="$request.contextPath/js/ui/js/om-grid.js"></script>
<script src="$request.contextPath/js/ui/js/om-mouse.js"></script>
<script src="$request.contextPath/js/ui/js/om-draggable.js"></script>
<script src="$request.contextPath/js/ui/js/om-position.js"></script>
<script src="$request.contextPath/js/ui/js/om-resizable.js"></script>
<script src="$request.contextPath/js/ui/js/om-dialog.js"></script>
<script src="$request.contextPath/js/ui/js/om-validate.js"></script>
<script src="$request.contextPath/js/ui/js/om-messagebox.js"></script>
<script src="$request.contextPath/js/ui/js/om-messagetip.js"></script>
<script src="$request.contextPath/js/ui/js/om-button.js"></script>
<script src="$request.contextPath/js/ui/js/om-combo.js"></script>
<script type="text/javascript" src="$request.contextPath/js/ui/js/om-ajaxsubmit.js"></script>
<script src="$request.contextPath/js/busi/hftaskmnt.js"></script>
<script type="text/javascript">
    jQuery(document).ready(function() {
       //用于更具权限判断控件是否显示
    	var optStr = "${opts}";
        var opts = optStr.split(',');
        jQuery('[code]').each(function() {
            var code = $(this).attr("code");
            for (var i = 0; i < opts.length; i++) {
                if (code == opts[i]) {
                    $(this).css('display', 'inline');
                }
            };
        });
        
      	//执行状态下拉框
  	 	$('#state').omCombo({
  	 		dataSource: '$request.contextPath/option/dropdownlist.do?paraType=timerTaskStates',
            width: '80px',
            emptyText: '全部',
            forceSelection: true,
            onSuccess:function(data, textStatus, event){
		      	  var tmp = $.parseJSON('{"value":"","text":"全部"}');
		      	  data.unshift(tmp);
	   		}
        });
      	
  		//初始化所属平任务下拉框
        $('#taskId').omCombo({
            dataSource: '$request.contextPath/timetask/getTaskDropDownList.do',
            width: '280px',
            emptyText: '全部',
            forceSelection: true,
            onSuccess:function(data, textStatus, event){
		      	  var tmp = $.parseJSON('{"value":"","text":"全部"}');
		      	  data.unshift(tmp);
	   		}
        });
  		
      	//触发方式下拉框初始化
  	 	$('#sendType').omCombo({
            dataSource: [{text:'全部',value:''},
                         {text:'自动',value:'1'}, 
                         {text:'手动',value:'2'}], 
            width: '50px',
            emptyText: '全部',
            forceSelection: true
        });
		
        //查询表格
        jQuery('#grid').omGrid({
            dataSource: "$request.contextPath/timetask/queryTaskMntInfo.do?queryKey=hfTask.queryTaskMntInfo",
            width: '100%',
            height: 475,
            limit: 15,
            title : '定 时 任 务 监 控',
            colModel: [{
                header: '任务流水号',
                name: 'TASKRPID',
                width: 170,
                align: 'center'
            },
            {
                header: '任务编号',
                name: 'TASKID',
                width: 130,
                align: 'center',
				renderer: function(value, rowData, rowIndex) {
					return "<a title='" + rowData.TASKDESC + "'>" + rowData.TASKID + "</a>";
                }
            },
            {
                header: '触发地址',
                name: 'POSTURL',
                width: 190,
                align: 'left',
                renderer: function(value, rowData, rowIndex) {
                	return "<a title='" + rowData.POSTURL + "'>" + rowData.POSTURL + "</a>";
                }
            },
            {
                header: '触发方式',
                name: 'SENDTYPE',
                width: 58,
                align: 'center',
                renderer: function(value, rowData, rowIndex) {
					if( rowData.SENDTYPE == 1 ){
						return "自动";
					}else{
						return "手动";
					}
                }
            },
            {
                header: '计划触发时间',
                name: 'PLANRUNTIME',
                width: 100,
                align: 'center'
            },
            {
                header: '实际触发时间',
                name: 'TASKRUNTIME',
                width: 100,
                align: 'center',
                renderer: function(value, rowData, rowIndex) {
					if( rowData.STATE == "0" ){
						return "--";
					}else{
						return rowData.TASKRUNTIME;
					}
                }
            },
            {
                header: '执行状态',
                name: 'STATEV',
                width: 60,
                align: 'center'
            },
            {
                header: '错误重试',
                name: 'ISRETRY',
                width: 60,
                align: 'center',
                renderer: function(value, rowData, rowIndex) {
					if( rowData.ISRETRY == 2 ){
						return "是";
					}else{
						return "否";
					}
                }
            },
            {
                header: '异常次数',
                name: 'ERRORTIMES',
                width: 85,
                align: 'center' ,
                renderer: function(value, rowData, rowIndex) {
                    return  rowData.ERRORTIMES+"(可重试" + rowData.RETRYTIMES+"次）";
                }
            },
            {
                header: '操作',
                name: 'OPT',
                width: 35,
                align: 'center',
                renderer: function(value, rowData, rowIndex) {
                    var result = "<img title='详情' src='${request.contextPath}/profile/default/images/tool_details.png' onclick='showDetailDialog(\"" + rowData.TASKRPID + "\")' />";
                    return result;
                }
            }],
            autoFit: false
        });

        jQuery( "#dialog").omDialog({
            autoOpen: false
        });
        
		jQuery('#modify').bind('click',
        function() {
            var selections = $('#grid').omGrid('getSelections', true);
            if (selections.length == 0) {
                alert('请至少选择一行记录');
                return false;
            }
            showModifyDialog(selections[0].MERID); //显示dialog
        });
		
		$('.errorImg').bind('mouseover',function(){
        $(this).next().css('display','block');
		}).bind('mouseout',function(){
				$(this).next().css('display','none');
		});
		
		jQuery('#dataform').submit(function() {
			if (!jQuery("#dataform").valid()) 
				return false;
			jQuery(this).omAjaxSubmit({success:function(res){
		      showSimpleTip(res);
				close();
			}
			});
			
			return false; 
		});
	});
	
	
</script>
</head>
<body>
 <div class="main_list">
   <!--列表查询区-->
   <div class="list_search" style="height: 40px;">
   <table width="100%" border="0">
   <tr>
    <td width="300">
      <form id="form" action="" method="post"> 
        <table width="100%" border="0">
          <tr height="50">
           	<th>任务流水：</th>
            <td nowrap="nowrap"><input id="taskRpid" name="taskRpid" type="text" class="input2" style="width:165px" maxlength="23"/></td>
            <th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;定时任务：</th>
            <td><input id="taskId"  name="taskId" /></td>
		   	<th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;执行状态：</th>
            <td><input id="state"  name="state" /></td>
            <th>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;触发方式：</th>
            <td><input id="sendType"  name="sendType" /></td>
         </tr>
        </table>
       </form> 
       </td>
        <td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			<input id="query" code="001"  name="query" type="image" value="ee" src="${request.contextPath}/profile/default/images/Search_bnt.png" onclick="queryTaskMntInfo();"  />
			&nbsp;&nbsp;&nbsp;&nbsp;
       </tr>
        </table>
      </div>
    
 <!--列表查询区-->

  <div align="center">
         <table  align="left" id="grid" ></table>
     </div>
    
  
 <div id="dialog">
	<iframe frameborder="0" style="width:100%;height:99%" src="about:blank"></iframe>
 </div>

</body>
</html>
